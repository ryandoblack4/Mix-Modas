<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>

<!-- C√≥digo DIRETO e FUNCIONAL -->
<script>
  console.log("üöÄ Sistema de Login - Iniciando...");
  
  let firebaseApp = null;
  
  /**
   * Inicializa√ß√£o DIRETA
   */
  function initializeFirebase() {
    if (firebaseApp) {
      console.log("‚úÖ Firebase j√° inicializado");
      return firebaseApp;
    }
    
    try {
      console.log("üîÑ Inicializando Firebase...");
      
      if (typeof firebase === 'undefined') {
        throw new Error("Firebase SDK n√£o carregado");
      }
      
      // üî• CR√çTICO: OBJETO DE CONFIGURA√á√ÉO AQUI! Use SUAS chaves.
      const firebaseConfig = {
        apiKey: "AIzaSyAhtHCacGDIR_49DMmVxBWuqLRocwSgRDk",
        authDomain: "sistema-de-loja-85c8a.firebaseapp.com",
        databaseURL: "https://sistema-de-loja-85c8a-default-rtdb.firebaseio.com",
        projectId: "sistema-de-loja-85c8a",
        storageBucket: "sistema-de-loja-85c8a.firebasestorage.app",
        messagingSenderId: "514984327740",
        appId: "1:514984327740:web:f63757577a32d0fa8da139"
      };
      // üî• FIM DA CONFIGURA√á√ÉO
      
      console.log("üìã Usando projeto:", firebaseConfig.projectId);
      
      if (!firebase.apps.length) {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        console.log("‚úÖ Firebase inicializado com sucesso!");
      } else {
        firebaseApp = firebase.apps[0];
        console.log("‚úÖ Firebase j√° estava inicializado");
      }
      
      return firebaseApp;
      
    } catch (error) {
      console.error("‚ùå Erro ao inicializar Firebase:", error);
      throw error;
    }
  }
  
  /**
   * Fun√ß√£o de login
   */
  async function loginFirebaseFrontend(email, senha) {
    console.log("üîê Tentando login para:", email);
    
    try {
      // Inicializa Firebase
      const app = initializeFirebase();
      if (!app) {
        return {
          success: false,
          error: "Sistema de autentica√ß√£o indispon√≠vel"
        };
      }
      
      if (typeof firebase.auth !== 'function') {
        return {
          success: false,
          error: "M√≥dulo de autentica√ß√£o n√£o carregado"
        };
      }
      
      const userCredential = await firebase.auth().signInWithEmailAndPassword(email, senha);
      const user = userCredential.user;
      
      // Salva no localStorage
      localStorage.setItem('usuarioLogado', 'true');
      localStorage.setItem('userEmail', user.email);
      localStorage.setItem('userUID', user.uid);
      localStorage.setItem('userName', user.displayName || email.split('@')[0]);
      localStorage.setItem('loginTime', Date.now().toString());
      
      console.log("‚úÖ Login bem-sucedido! Dados salvos:", {
        email: user.email,
        uid: user.uid,
        localStorage: {
          usuarioLogado: localStorage.getItem('usuarioLogado'),
          userEmail: localStorage.getItem('userEmail')
        }
      });
      
      return {
        success: true,
        user: {
          email: user.email,
          uid: user.uid
        }
      };
      
    } catch (error) {
      console.error("‚ùå Erro no login:", error.code, error.message);
      
      let mensagem = "Email ou senha incorretos";
      if (error.code === 'auth/invalid-email') mensagem = "Email inv√°lido";
      if (error.code === 'auth/user-not-found') mensagem = "Usu√°rio n√£o encontrado";
      if (error.code === 'auth/wrong-password') mensagem = "Senha incorreta";
      if (error.code === 'auth/too-many-requests') mensagem = "Muitas tentativas. Aguarde.";
      
      return {
        success: false,
        error: mensagem
      };
    }
  }
  
  /**
   * Verifica se usu√°rio est√° logado
   */
  function verificarUsuarioLogado() {
    const logado = localStorage.getItem('usuarioLogado') === 'true';
    const email = localStorage.getItem('userEmail');
    const loginTime = localStorage.getItem('loginTime');
    
    // Verifica se n√£o expirou (24 horas)
    if (loginTime) {
      const horas = (Date.now() - parseInt(loginTime)) / (1000 * 60 * 60);
      if (horas > 24) {
        console.log("‚ö†Ô∏è Login expirado (mais de 24 horas)");
        localStorage.removeItem('usuarioLogado');
        return false;
      }
    }
    
    console.log("üîç Verifica√ß√£o de login:", {
      logado: logado,
      email: email,
      temDados: !!(email && logado)
    });
    
    return logado && email;
  }
  
  /**
   * Logout
   */
  function logoutFirebase() {
    console.log("üö™ Fazendo logout...");
    
    const keys = ['usuarioLogado', 'userEmail', 'userUID', 'userName', 'loginTime'];
    keys.forEach(key => localStorage.removeItem(key));
    
    if (firebaseApp && typeof firebase.auth === 'function') {
      firebase.auth().signOut();
    }
    
    window.location.href = '/templates/index.html';
  }
  
  // Exporta fun√ß√µes
  window.loginFirebaseFrontend = loginFirebaseFrontend;
  window.verificarUsuarioLogado = verificarUsuarioLogado;
  window.logoutFirebase = logoutFirebase;
  window.initializeFirebase = initializeFirebase;
  
  console.log("‚úÖ Sistema de login carregado e pronto");
</script>

<!-- L√≥gica da p√°gina -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log("üìÑ P√°gina de login carregada");
    
    const loginForm = document.getElementById("loginForm");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const submitBtn = document.getElementById("submitBtn");
    const mensagemDiv = document.getElementById("mensagem");
    
    // üî• CR√çTICO: Remove a verifica√ß√£o que redireciona de volta!
    // O problema de loop era aqui. A p√°gina de login N√ÉO deve verificar
    // e redirecionar para si mesma se o usu√°rio j√° estiver logado.
    // Essa verifica√ß√£o deve ficar SOMENTE no index.html.
    
    // Fun√ß√£o para mostrar mensagem
    function mostrarMensagem(texto, tipo) {
      mensagemDiv.textContent = texto;
      mensagemDiv.className = tipo === 'success' ? 'success-message' : 'error-message';
    }
    
    // Inicializa Firebase imediatamente
    try {
      initializeFirebase();
      console.log("üéâ Firebase pronto para uso");
    } catch (error) {
      console.error("Erro no Firebase:", error);
      mostrarMensagem("‚ö†Ô∏è Sistema temporariamente indispon√≠vel", "error");
    }
    
    // Evento de submit
    loginForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      
      const email = emailInput.value.trim();
      const senha = passwordInput.value.trim();
      
      if (!email || !senha) {
        mostrarMensagem("Preencha e-mail e senha", "error");
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = "Processando...";
      mensagemDiv.textContent = "";
      
      try {
        console.log("üîÑ Processando login...");
        const resultado = await loginFirebaseFrontend(email, senha);
        
        if (!resultado.success) {
          mostrarMensagem(resultado.error, "error");
          submitBtn.disabled = false;
          submitBtn.textContent = "Entrar";
          passwordInput.value = "";
          passwordInput.focus();
          return;
        }
        
        // SUCESSO
        mostrarMensagem("‚úì Login realizado! Redirecionando...", "success");
        
        // Aguarda 2 segundos e redireciona
        setTimeout(() => {
          console.log("‚û°Ô∏è Indo para index.html...");
          window.location.href = "/templates/index.html";
        }, 2000);
        
      } catch (error) {
        console.error("Erro inesperado:", error);
        mostrarMensagem("Erro inesperado. Tente novamente.", "error");
        submitBtn.disabled = false;
        submitBtn.textContent = "Entrar";
      }
    });
    
    emailInput.focus();
  });
</script>
</body>
</html>